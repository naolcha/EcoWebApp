{% extends "base.html" %}
{% block title %}Профиль — ЭкоЗаправки{% endblock %}

{% block content %}
<section class="profile-section">
  <div class="container">
    <h1>Профиль пользователя</h1>

    {% if request.query_params.get('fav') == 'added' %}
      <div class="toast toast-success" role="status">
        Станция добавлена в избранное
      </div>
    {% elif request.query_params.get('fav') == 'removed' %}
      <div class="toast" role="status">
        Станция удалена из избранного
      </div>
    {% endif %}

    {% if is_admin %}
    <div class="admin-banner">
      <p>У вас есть права администратора. (Роль: {{ user.role }})</p>
      <a href="/admin" class="btn-admin">Перейти в панель администратора</a>
    </div>
    {% endif %}

    <div class="profile-grid">
      <div class="profile-card">
        <h2>{{ user.username }}</h2>
        <p class="email">{{ user.email }}</p>
        <p class="date">Роль: <strong>{{ user.role }}</strong></p>
        <p class="date">Дата регистрации: {{ user.created_at.strftime("%d.%m.%Y") }}</p>
        <a href="/profile/edit" class="btn-edit">Редактировать профиль</a>
      </div>

      <div class="stats-card">
        <h3>Статистика</h3>
        <div class="stats-list">
          <div>
            <span class="num">{{ reviews|length }}</span>
            <p>Отзывов оставлено</p>
          </div>
          <div>
            <span class="num">{{ reviews|selectattr("rating", "equalto", 5)|list|length }}</span>
            <p>Оценок 5</p>
          </div>
          <div>
            <span class="num">{{ favorites|length if favorites else 0 }}</span>
            <p>В избранном</p>
          </div>
        </div>
      </div>
    </div>

    {% if not is_admin %}
    <h2 class="section-header">Избранное</h2>
    {% if favorites %}
      <div class="favorites-grid">
        {% for st in favorites %}
          <a class="fav-card" href="/station/{{ st.id }}">
            <div class="fav-top">
              <h3 class="fav-title">{{ st.name }}</h3>
              <span class="eco-pill {{ 'eco' if st.eco_status else 'not-eco' }}">
                {% if st.eco_status %}Эко{% else %}Не эко{% endif %}
              </span>
            </div>
            <p class="fav-sub">{{ st.address or "—" }}</p>
            <p class="fav-meta">
              {{ st.district or "—" }}{% if st.admarea %} · {{ st.admarea }}{% endif %}
            </p>
          </a>
        {% endfor %}
      </div>
    {% else %}
      <p class="empty-block">Пока нет избранных станций.</p>
    {% endif %}

    <h2 class="section-header">Мои отзывы</h2>

    {% if reviews %}
    <div class="reviews-grid">
      {% for review in reviews %}
      <div class="review-card">
        <div class="review-header-row">
          <a class="review-station" href="/station/{{ review.station_id }}">{{ review.station_name }}</a>
          <span class="badge">{{ review.rating }}★</span>
        </div>
        {% if review.comment %}
        <p class="comment">"{{ review.comment }}"</p>
        {% endif %}
        <p class="date">{{ review.created_at.strftime("%d.%m.%Y") }}</p>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <p class="empty-block">Вы ещё не оставляли отзывов.</p>
    {% endif %}
    {% endif %}
  </div>
</section>

<style>
.profile-section {
  background: #f8fafc;
  padding: 60px 0;
  color: #1e293b;
  font-family: 'Inter', sans-serif;
}

h1 { font-size: 2rem; margin-bottom: 1rem; }

.admin-banner {
  background: linear-gradient(90deg, #16a34a, #22c55e);
  color: white;
  border-radius: 12px;
  padding: 1rem 1.5rem;
  margin-bottom: 2rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 1rem;
}

.btn-admin {
  background: white;
  color: #16a34a;
  padding: 8px 16px;
  border-radius: 6px;
  text-decoration: none;
  font-weight: 500;
  transition: all .2s ease;
  white-space: nowrap;
}
.btn-admin:hover { background: #e2e8f0; }

.profile-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 1.5rem;
  margin-bottom: 2rem;
}

.profile-card, .stats-card {
  background: #fff;
  border-radius: 14px;
  padding: 1.5rem;
  box-shadow: 0 4px 20px rgba(0,0,0,0.05);
  transition: transform .2s ease, box-shadow .2s ease;
}
.profile-card:hover, .stats-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 24px rgba(0,0,0,0.08);
}

.profile-card h2 { font-size: 1.4rem; color: #0f172a; margin-bottom: 0.25rem; }
.email { color: #475569; margin-bottom: 0.5rem; }
.date { color: #94a3b8; font-size: 0.9rem; }

.btn-edit {
  display: inline-block;
  margin-top: 1rem;
  background: #16a34a;
  color: #fff;
  padding: 10px 18px;
  border-radius: 8px;
  font-weight: 500;
  text-decoration: none;
  transition: background .2s;
}
.btn-edit:hover { background: #15803d; }

.stats-card h3 { margin-bottom: 1rem; color: #0f172a; }
.stats-list {
  display: grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap: 10px;
  text-align: center;
}
.num { font-size: 2rem; color: #16a34a; font-weight: 600; }
.stats-list p { font-size: 0.9rem; color: #475569; margin: 0; }

.section-header {
  margin-top: 34px;
  margin-bottom: 16px;
}

.empty-block {
  color: #94a3b8;
  font-style: italic;
  margin-top: 0.5rem;
}

.favorites-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
  gap: 1.2rem;
}

.fav-card {
  background: #fff;
  border-radius: 12px;
  padding: 1rem 1.25rem;
  box-shadow: 0 2px 10px rgba(0,0,0,0.05);
  transition: all .2s ease;
  text-decoration: none;
  color: inherit;
  border: 1px solid rgba(15, 23, 42, 0.06);
}
.fav-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(0,0,0,0.08);
}

.fav-top {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 10px;
  margin-bottom: 6px;
}

.fav-title {
  font-size: 1.05rem;
  color: #0f172a;
  margin: 0;
  line-height: 1.25;
}

.fav-sub {
  margin: 6px 0 0;
  color: #475569;
}

.fav-meta {
  margin: 8px 0 0;
  color: #94a3b8;
  font-size: 0.9rem;
}

.eco-pill {
  font-size: 0.85rem;
  padding: 4px 10px;
  border-radius: 999px;
  white-space: nowrap;
  border: 1px solid rgba(15, 23, 42, 0.08);
}
.eco-pill.eco { background: rgba(22, 163, 74, 0.10); color: #15803d; }
.eco-pill.not-eco { background: rgba(245, 158, 11, 0.12); color: #b45309; }

.reviews-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
  gap: 1.2rem;
}

.review-card {
  background: #fff;
  border-radius: 12px;
  padding: 1rem 1.25rem;
  box-shadow: 0 2px 10px rgba(0,0,0,0.05);
  transition: all .2s ease;
}
.review-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(0,0,0,0.08);
}

.review-header-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 10px;
}

.review-station {
  font-size: 1.1rem;
  color: #0f172a;
  text-decoration: none;
}
.review-station:hover { text-decoration: underline; }

.badge {
  background: #16a34a;
  color: white;
  padding: 4px 10px;
  border-radius: 6px;
  font-size: 0.9rem;
}

.comment { color: #475569; font-style: italic; margin: 10px 0; }

.toast {
  background: #0f172a;
  color: #fff;
  padding: 12px 14px;
  border-radius: 12px;
  margin: 0 0 18px;
  display: inline-block;
  box-shadow: 0 10px 30px rgba(0,0,0,0.18);
  animation: toastIn .2s ease-out;
}
.toast-success { background: #16a34a; }
@keyframes toastIn {
  from { transform: translateY(-6px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}
</style>

<script>
  const toast = document.querySelector('.toast');
  if (toast) setTimeout(() => toast.remove(), 2600);
</script>
{% endblock %}